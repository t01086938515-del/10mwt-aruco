# 개선방안 목록

> 작성일: 2026-02-10
> 검증 과정에서 발견된 개선 가능 포인트 정리

---

# 근본 해결 (L/R 감지 실패의 원인 해결)

현재 핵심 문제: **측면 카메라 + heel 키포인트 없음 → 양발 ankle Y 신호가 거의 동일 → L/R 구분 자체가 안 됨**
이로 인해 bilateral dedup, 교대 강제, heel_y 비교 등 모든 후처리가 "땜빵"이 됨.

**모든 하류 지표가 HS 감지 정확도에 의존:**
- Step Length L/R, Step Time L/R → HS 감지 + leading_foot 라벨 정확도에 직접 의존
- Stride Length L/R, Stride Time L/R → HS 감지 정확도에 직접 의존 (인덱스 기반이어도 HS 누락 시 뒤집힘)
- Swing/Stance, SI → 위 지표들의 파생
- **측정 방법(라벨/인덱스)을 바꿔도 HS 감지가 부정확하면 해결 안 됨**
- **근본 해결 = HS 감지 정확도 향상 (A, B, E)이 유일한 해법**

---

## A. Foot Separation 하이브리드 Step Detection

| | 개선 전 | 개선 후 |
|---|---|---|
| **방법** | Y-peak만으로 HS 감지 | Y-peak + `\|left_x - right_x\|` 피크 결합, 품질 비교 후 선택 |
| **문제** | 3개 영상(5199/5200/5201) 실패 | Y축 우회로 3개 영상 해결 |
| **결과** | 5200: 7 events, 5201: 16 events | 5200: 13 events, 5201: 10 events |

- **왜 근본인가**: Y축 신호를 아예 안 쓰고 X축 거리만으로 감지 → heel 없음 + crosstalk 문제를 통째로 우회
- **난이도**: 낮음 (processor.py만 수정)
- **리스크**: 낮음 (기존 로직 유지, 품질 비교 후 선택)
- **우선순위**: 1순위
- **발견 경위**: 섹션 2 검증 중 hs_diagnostic.py 진단 결과

---

## B. MediaPipe heel 키포인트 도입

| | 개선 전 | 개선 후 |
|---|---|---|
| **모델** | YOLOv8 COCO 17개 키포인트 | MediaPipe 33개 (heel #29,30 + toe #31,32) 또는 YOLO+MediaPipe 하이브리드 |
| **heel 가용률** | 0% → ankle 대체 → Y 진폭 약함 | 70~90% → heel Y 직접 사용 → Y 진폭 강함 |
| **Y range** | 10~15px (ankle) | 30~40px (heel, 2~3배 증가) |

- **왜 근본인가**: heel 키포인트 확보 → Y 진폭 커짐 → 양발 신호 분리됨
- **난이도**: 중간 (pose_detector.py 구조 변경 + 의존성 추가)
- **리스크**: MediaPipe 사람감지 약함 → 하이브리드 필요
- **우선순위**: 2순위 (장기적 근본 해결)
- **발견 경위**: 섹션 2 검증 중 heel 가용률 0% 확인

---

## E. 카메라 셋업 가이드

| | 개선 전 | 개선 후 |
|---|---|---|
| **촬영 조건** | 표준화 없음 | 권장 촬영 거리, 높이, 각도 가이드 문서 제공 |
| **양발 depth 차이** | 측면 촬영 → crosstalk + 원근 비대칭 | 촬영 각도 개선 → depth 차이 줄임 → crosstalk 감소 |
| **코드 변경** | - | 없음 (문서만) |

- **왜 근본인가**: 촬영 각도 개선 → 양발 depth 차이 줄임 → crosstalk 감소
- **난이도**: 없음 (문서만)
- **우선순위**: 상시 (장기적 품질 보장)
- **발견 경위**: 섹션 2 검증 중 bilateral crosstalk 원인 분석

---

# 정밀도 향상 (근본 해결 후 추가 개선)

근본 문제 해결 후 결과의 정확도를 높이는 개선.

---

## C. Homography를 vx 계산에 확장

| | 개선 전 | 개선 후 |
|---|---|---|
| **vx 계산** | pixel 기반 (원근 미보정) | 실세계 좌표 변환 후 vx 계산 |
| **거리 보정** | Step/Stride Length만 적용 | vx 포함 전체 적용 |
| **L/R vx 비대칭** | 카메라 원근으로 발생 | 원근 보정으로 감소 |

- **미적용 부분**:
  - Y-peak vx 필터 (line 441): 영향 적음 (같은 발 내 비교)
  - Vx-crossing 감지 (line 467, 586-587): 영향 있음 (양발 합산 기준)
  - Swing/Stance 분석 (line 905-906): 영향 있음 (양발 합산 기준)
- **효과**: L/R vx 비대칭 감소 → Swing/Stance SI, Step Time SI 개선 (전체 7개 영상)
- **난이도**: 중간 (PerspectiveCorrector에 `transform_point()` 추가)
- **리스크**: 낮음
- **발견 경위**: 섹션 2 Q&A "Homography 보정 왜 vx에 안 되나?"

---

## D. Per-foot 분리 threshold (Swing/Stance)

| | 개선 전 | 개선 후 |
|---|---|---|
| **threshold** | 양발 합산 `median(\|all_vx\|) * 1.2` 단일 | 각 발별 별도 threshold 계산 |
| **원근 비대칭** | 가까운 발 vx 크게 → 편향 | 발별 기준이라 원근 차이 완화 |
| **Swing/Stance L/R** | 비대칭 가능 | 정확도 향상 |

- **난이도**: 낮음 (몇 줄 수정)
- **리스크**: 매우 낮음
- **발견 경위**: 섹션 2 Q&A "카메라 원근 효과가 vx에 미치는 영향"

---

## H. Bilateral dedup heel_y 비교 기준 개선

| | 개선 전 | 개선 후 |
|---|---|---|
| **병합 기준** | dt < 0.15s 시 heel_y 높은 쪽 유지 | vx 낮은 쪽(진짜 착지) 또는 prominence 큰 쪽(확실한 피크) 유지 |
| **편향** | 카메라 가까운 발이 항상 이김 | 실제 HS 특성 기반 선택 → 편향 감소 |
| **라벨 영향** | Leading Foot은 이후 재판별 → 라벨 무관 | 동일 (타이밍에만 미세 영향) |

- **난이도**: 낮음 (비교 기준만 변경)
- **리스크**: 낮음
- **발견 경위**: 섹션 2-4 Q&A "heel_y 비교가 가까운 발에 편향"

---

## I. 기본 지표 step/stride length를 실측 기반으로 교체

| | 개선 전 | 개선 후 |
|---|---|---|
| **step_length** | `10m / step_count` (산술 평균) | 섹션 5 실측 L/R step length 평균 |
| **stride_length** | `10m / (step_count // 2)` (= step × 2) | 섹션 5 실측 L/R stride length 평균 |
| **정확도** | 산술적 추정 | 실제 측정 기반 |

- **난이도**: 낮음 (섹션 5 계산 결과를 기본 지표에 반영)
- **리스크**: 낮음
- **조건**: 섹션 5 로직 검증/수정 완료 후 적용
- **발견 경위**: 섹션 4 검증 중 "stride가 그냥 step×2" 확인

---

## J. speed_mps 시간 기준 통일

| | 개선 전 | 개선 후 |
|---|---|---|
| **speed 시간** | `timer_elapsed_s` (타이머 기반) | crossing event 기반 `elapsed` |
| **cadence 시간** | `elapsed` (crossing event 기반) | 동일 |
| **일관성** | 서로 다른 시간 기준 (차이 ~0.05s) | 전체 지표 동일 시간 기준 |

- **난이도**: 낮음
- **리스크**: 낮음 (차이 0.05s 이내)
- **발견 경위**: 섹션 4 검증 중 speed와 cadence의 시간 기준 불일치 발견

---

## K. stride_length_si를 overall_si에 포함

| | 개선 전 | 개선 후 |
|---|---|---|
| **calc_si 사용** | stride_length_si만 직접 계산 | `calc_si()` 사용으로 통일 |
| **si_values 포함** | 미포함 → overall_si에서 빠짐 | `si_values.append(si)` 추가 |
| **overall_si 구성** | 6개 SI 평균 | 7개 SI 전체 반영 |

- **난이도**: 매우 낮음 (2줄 수정)
- **리스크**: 없음
- **발견 경위**: 섹션 8 검증 중 stride_length_si가 si_values에 미포함 확인

---

# 장기 과제

---

## F. Perry 보행주기 이벤트 기반 재구성

| | 개선 전 | 개선 후 |
|---|---|---|
| **감지 이벤트** | IC(Heel Strike)만, 실패 시 X-crossing fallback | MSw + MSt + Max Separation 동시 감지 |
| **Swing/Stance** | vx threshold 기반 프레임 분류 | MSt→MSw / MSw→MSt 간격으로 직접 측정 |
| **IC 타이밍** | X-crossing ≈ Mid-Swing (부정확) | Max Separation → IC 타이밍 근사 가능 |

- **활용**:
  - MSt→MSw 간격 = swing phase 시간 (직접 측정)
  - MSw→MSt 간격 = stance phase 시간 (직접 측정)
  - Max Separation 시점 → IC 타이밍 근사 가능
- **효과**: Swing/Stance 정확도 향상 + X-crossing fallback 시 타이밍 보정
- **난이도**: 중~높음
- **발견 경위**: 섹션 2 Q&A "X-crossing이 Mid-Swing을 감지하는 것 아닌가?"

---

## G. 영상 전처리 파이프라인

| | 개선 전 | 개선 후 |
|---|---|---|
| **전처리** | 없음 (프레임 그대로 YOLO 입력) | CLAHE, 감마 보정, 샤프닝 등 적용 |
| **어두운 환경** | 키포인트 감지율 저하 | 감지율 향상 |
| **현재 문제 영상** | 영상 품질이 아닌 모델 한계가 원인 | 직접 효과 낮음 |

- **난이도**: 낮음
- **발견 경위**: 섹션 2 Q&A "신호 노이즈를 영상 보정으로 해결할 수 있나?"

---

## L. 개인 맞춤형 필터 범위 (환자 프로필 기반)

| | 개선 전 | 개선 후 |
|---|---|---|
| **필터 범위** | 고정 (step 0.2~2.0m, stride 0.3~4.0m 등) | 환자 프로필(키, 나이, 장애 수준) 기반 동적 조절 |
| **극단 케이스** | 유효 데이터가 필터에 걸려 제거됨 | 필터 범위 확장 또는 "이상 보행 후보"로 별도 보관 |
| **이상 보행 감지** | 불가 | 임상 참고용 별도 보관 가능 |

- **난이도**: 중간 (프로필 입력 UI + 범위 매핑 테이블 필요)
- **리스크**: 낮음
- **발견 경위**: 섹션 8-9 검증 중 고정형 필터의 개인차 미반영 확인

---

# 우선순위 요약

## 근본 해결
| 순위 | 방안 | 효과 | 난이도 |
|------|------|------|--------|
| 1 | A. Foot Separation 하이브리드 | 3개 영상 해결 (Y축 우회) | 낮음 |
| 2 | B. MediaPipe heel | heel 확보로 신호 분리 | 중간 |
| 상시 | E. 카메라 가이드 | 데이터 품질 근본 개선 | 없음 |

## 정밀도 향상 (근본 해결 후)
| 순위 | 방안 | 효과 | 난이도 |
|------|------|------|--------|
| 3 | C. Homography vx 확장 | 전체 SI 개선 | 중간 |
| 4 | D. Per-foot threshold | Swing/Stance 개선 | 낮음 |
| 5 | H. Dedup 비교 기준 | 타이밍 편향 감소 | 낮음 |
| 6 | I. step/stride 실측 교체 | 기본 지표 정확도 | 낮음 |
| 7 | J. speed 시간 기준 통일 | 지표 일관성 | 낮음 |
| 8 | K. stride_length_si 포함 | overall_si 완전성 | 매우 낮음 |

## 장기
| 순위 | 방안 | 효과 | 난이도 |
|------|------|------|--------|
| 장기 | F. Perry 보행주기 재구성 | Swing/Stance + 타이밍 | 중~높음 |
| 장기 | G. 영상 전처리 | 열악한 환경 대응 | 낮음 |
| 장기 | L. 개인 맞춤형 필터 | 다양한 환자군 + 이상 보행 감지 | 중간 |
