# 보행 분석 결과 판정 시스템 구현 프롬프트

## 목적
측면 영상 기반 보행 분석 프로그램에서 측정된 보행 변수들을 정상 참고치와 비교하여 판정 결과를 출력하는 모듈을 만들어줘.

---

## 1. 데이터 구조

### 입력값 (측정 결과)
프로그램에서 아래 변수들이 측정되어 딕셔너리로 전달됨:

```python
measured = {
    'gait_velocity_ms': float,       # 보행속도 (m/s)
    'cadence_spm': float,            # 분속수 (steps/min)
    'step_length_cm': float,         # 보폭 (cm)
    'stride_length_cm': float,       # 활보장 (cm)
    'step_time_s': float,            # step time (초)
    'stride_time_s': float,          # stride time (초)
    'stance_ratio_pct': float,       # 입각기 비율 (% of gait cycle)
    'swing_ratio_pct': float,        # 유각기 비율 (% of gait cycle)
    'double_support_pct': float,     # 양하지 지지기 비율 (% of gait cycle)
    'single_support_pct': float,     # 단하지 지지기 비율 (% of gait cycle)
    'stride_length_cv': float,       # 활보장 변동성 (CV%)
    'swing_time_cv': float,          # 유각기 시간 변동성 (CV%)
    'step_length_cv': float,         # 보폭 변동성 (CV%)
    'stance_time_cv': float,         # 입각기 시간 변동성 (CV%)
}
```

---

## 2. 정상 참고치 (한국인 성인 기준)

```python
NORMAL_RANGES = {
    'gait_velocity_ms':   {'min': 1.0,  'max': 1.4,  'unit': 'm/s'},
    'cadence_spm':        {'min': 100,  'max': 120,  'unit': 'steps/min'},
    'step_length_cm':     {'min': 55,   'max': 70,   'unit': 'cm'},
    'stride_length_cm':   {'min': 110,  'max': 140,  'unit': 'cm'},
    'step_time_s':        {'min': 0.50, 'max': 0.60, 'unit': 's'},
    'stride_time_s':      {'min': 1.00, 'max': 1.20, 'unit': 's'},
    'stance_ratio_pct':   {'min': 58,   'max': 62,   'unit': '%'},
    'swing_ratio_pct':    {'min': 38,   'max': 42,   'unit': '%'},
    'double_support_pct': {'min': 18,   'max': 24,   'unit': '%'},
    'single_support_pct': {'min': 38,   'max': 40,   'unit': '%'},
    'stride_length_cv':   {'min': 0,    'max': 4.4,  'unit': '%'},
    'swing_time_cv':      {'min': 0,    'max': 6.6,  'unit': '%'},
    'step_length_cv':     {'min': 0,    'max': 5.9,  'unit': '%'},
    'stance_time_cv':     {'min': 0,    'max': 5.3,  'unit': '%'},
}
```

---

## 3. 판정 로직

### 3-1. 보행속도: Perry 분류 적용 (유일하게 경/중/심 판정 가능)

| 조건 | 판정 | 라벨 색상 |
|------|------|----------|
| > 1.0 m/s | 정상 | 초록 |
| 0.8 ~ 1.0 m/s | 경도 저하 (낙상 위험 증가 시작, 모니터링 권장) | 노랑 |
| 0.4 ~ 0.8 m/s | 중등도 저하 (지역사회 보행 제한) | 주황 |
| < 0.4 m/s | 심각 (실내 보행만 가능) | 빨강 |

근거: Perry et al. 1995; Schmid et al. 2007 (Stroke)

### 3-2. 나머지 변수: 편차 수치 + 이상 방향만 표시

경/중/심 판정 라벨은 **붙이지 않는다** (합의된 근거 없음).
대신 아래 정보를 제공:

- 정상 범위 내 여부 (정상 / 정상 범위 초과 / 정상 범위 미달)
- 정상 범위 경계로부터의 편차 (절대값)
- 이상 방향 화살표 (↑ 또는 ↓)
- 임상 해석 코멘트

### 3-3. 이상 방향별 해석 코멘트 매핑

```python
CLINICAL_COMMENTS = {
    'stance_ratio_pct': {
        'high': '입각기 증가: 보행 안정성 보상 전략 가능성',
        'low':  '입각기 감소: 빠른 보행 또는 측정 오차 확인 필요',
    },
    'swing_ratio_pct': {
        'high': '유각기 증가: 빠른 보행 시 정상적 변화',
        'low':  '유각기 감소: 낙상 위험 증가 방향 (Verghese 2009)',
    },
    'double_support_pct': {
        'high': '양하지 지지기 증가: 안정성 보상 패턴, 낙상 위험 증가 방향 (RR 1.165, Verghese 2009)',
        'low':  '양하지 지지기 감소: 빠른 보행 시 정상적 변화',
    },
    'single_support_pct': {
        'high': '단하지 지지기 증가: 빠른 보행 시 정상적 변화',
        'low':  '단하지 지지기 감소: 균형 능력 저하 가능성',
    },
    'step_length_cm': {
        'high': '보폭 증가: 정상 범위 확인',
        'low':  '보폭 감소: 낙상 이력자에서 관찰되는 패턴 (Verghese 2009)',
    },
    'stride_length_cm': {
        'high': '활보장 증가: 정상 범위 확인',
        'low':  '활보장 감소: 노화 또는 보행 장애 시 10~20% 감소 (AAFP 2010)',
    },
    'cadence_spm': {
        'high': '분속수 증가: 짧은 보폭 보상 가능성 (한국인 노인 특징, Kim & Lee 2020)',
        'low':  '분속수 감소: 느린 보행 반영',
    },
    'step_time_s': {
        'high': 'Step time 증가: 느린 보행 반영',
        'low':  'Step time 감소: 빠른 보행 반영',
    },
    'stride_time_s': {
        'high': 'Stride time 증가: 느린 보행 반영',
        'low':  'Stride time 감소: 빠른 보행 반영',
    },
    'stride_length_cv': {
        'high': '활보장 변동성 증가: 낙상 예측인자 (RR 1.076, Verghese 2009)',
    },
    'swing_time_cv': {
        'high': '유각기 시간 변동성 증가: 낙상 예측인자 (Verghese 2009)',
    },
    'step_length_cv': {
        'high': '보폭 변동성 증가: 인지기능 저하 연관 가능 (Hollman 2011)',
    },
    'stance_time_cv': {
        'high': '입각기 시간 변동성 증가: 보행 불안정성 반영 (Hollman 2011)',
    },
}
```

---

## 4. 출력 형식

### 4-1. 결과 딕셔너리 구조

각 변수에 대해 아래 구조로 반환:

```python
{
    'variable_name': str,          # 변수 영문명
    'display_name': str,           # 변수 한글명
    'measured_value': float,       # 측정값
    'unit': str,                   # 단위
    'normal_range': str,           # "58~62%" 형태
    'status': str,                 # "정상" / "상한 초과" / "하한 미달"
    'deviation': float or None,    # 경계로부터의 편차 (정상이면 None)
    'direction': str or None,      # "↑" / "↓" / None
    'clinical_comment': str,       # 임상 해석 코멘트
    'classification': str or None, # 보행속도만 해당: "정상"/"경도 저하"/"중등도 저하"/"심각"
    'color': str,                  # "green"/"yellow"/"orange"/"red"/"gray"
}
```

### 4-2. 색상 규칙

- 보행속도: Perry 분류에 따라 green/yellow/orange/red
- 나머지 변수:
  - 정상 범위 내 → green
  - 정상 범위 벗어남 → orange (방향에 관계없이)

### 4-3. 한글 변수명 매핑

```python
DISPLAY_NAMES = {
    'gait_velocity_ms':   '보행속도',
    'cadence_spm':        '분속수 (Cadence)',
    'step_length_cm':     '보폭 (Step Length)',
    'stride_length_cm':   '활보장 (Stride Length)',
    'step_time_s':        'Step Time',
    'stride_time_s':      'Stride Time (보행주기)',
    'stance_ratio_pct':   '입각기 비율 (Stance)',
    'swing_ratio_pct':    '유각기 비율 (Swing)',
    'double_support_pct': '양하지 지지기 (Double Support)',
    'single_support_pct': '단하지 지지기 (Single Support)',
    'stride_length_cv':   '활보장 변동성 (CV)',
    'swing_time_cv':      '유각기 시간 변동성 (CV)',
    'step_length_cv':     '보폭 변동성 (CV)',
    'stance_time_cv':     '입각기 시간 변동성 (CV)',
}
```

---

## 5. 결과 리포트 하단에 반드시 포함할 문구

```
[참고사항]
- 보행속도 판정은 Perry et al.(1995) 기능적 보행 분류에 근거합니다.
- 보행속도를 제외한 변수의 경/중/심 판정은 현재 합의된 임상 근거가 없어
  정상 범위 대비 편차만 제공합니다.
- 정상 참고치는 한국인 성인 대상 연구(Kim et al. 2024; Kim & Lee 2020;
  Cho et al. 2004)와 국제 문헌을 종합한 대략적 범위입니다.
- 측면 영상 기반 측정은 GAITRite 등 gold standard 대비 오차가 있을 수 있습니다.
- 최종 임상 해석은 반드시 전문가(물리치료사, 재활의학과)가 수행해야 합니다.
```

---

## 6. 추가 기능 (선택)

### 6-1. 보행속도 추가 경고

```python
VELOCITY_ALERTS = {
    0.6: '⚠️ 0.6 m/s 미만: 신체 장애 고위험, 입원 예측인자 (Cesari 2005)',
    0.7: '⚠️ 0.7 m/s 이하: 낙상 위험 1.5배 증가 (Verghese 2009)',
}
```

### 6-2. 변수 간 패턴 해석

여러 변수가 동시에 이상일 때 종합 코멘트:

```python
PATTERN_COMMENTS = {
    # 조건: (stance↑, swing↓, double_support↑, velocity↓)
    'stability_compensation': {
        'condition': 'stance_high AND swing_low AND double_support_high AND velocity_low',
        'comment': '안정성 보상 보행 패턴: 입각기 증가, 유각기 감소, 양하지 지지기 증가가 '
                   '동시에 관찰되며, 이는 균형 능력 저하에 대한 보상 전략일 수 있습니다.',
    },
    # 조건: (step_length↓, stride_length↓, cadence↑)
    'short_step_pattern': {
        'condition': 'step_length_low AND stride_length_low AND cadence_high',
        'comment': '짧은 보폭 패턴: 보폭과 활보장이 감소하면서 분속수가 증가하는 패턴으로, '
                   '한국인 노인에서 흔히 관찰되는 안정성 확보 전략입니다 (Kim & Lee 2020).',
    },
    # 조건: CV 변수들 다수 이상
    'high_variability': {
        'condition': 'two_or_more_cv_high',
        'comment': '보행 변동성 증가: 2개 이상의 변동성(CV) 지표가 정상 범위를 초과하여 '
                   '보행 불안정성이 의심됩니다. 낙상 위험 평가를 권장합니다 (Verghese 2009).',
    },
}
```

---

## 7. 구현 시 주의사항

1. 모든 수치는 소수점 첫째 자리까지 표시 (반올림)
2. 정상 범위 내인 변수도 결과표에 포함 (전체 그림을 보여주기 위해)
3. 보행속도 Perry 분류는 반드시 별도 섹션으로 강조 표시
4. CV(변동성) 변수는 최소 5 stride 이상 데이터가 있을 때만 계산
5. 측정 불가한 변수는 "N/A"로 표시하고 판정하지 않음
6. 결과 리포트는 PDF 또는 화면 출력 모두 지원
